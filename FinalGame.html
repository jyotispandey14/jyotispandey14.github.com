<html>
<head>
  <title>Facebook GAME!</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <style>
  .initialRotation
	{
		width:1500px;
		height:700px;

		transform: rotate3d(0,1,0,45deg);
		-moz-transform: rotate3d(0,1,0,45deg);
		-ms-transform: rotate3d(0,1,0,45deg);
		-o-transform: rotate3d(0,1,0,45deg);
		-webkit-transform: rotate3d(0,1,0,45deg);
	}
	
	.button {
		-moz-box-shadow:inset 0px 1px 0px 0px #ffffff;
		-webkit-box-shadow:inset 0px 1px 0px 0px #ffffff;
		box-shadow:inset 0px 1px 0px 0px #ffffff;
		background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #f9f9f9), color-stop(1, #e9e9e9) );
		background:-moz-linear-gradient( center top, #f9f9f9 5%, #e9e9e9 100% );
		filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#f9f9f9', endColorstr='#e9e9e9');
		background-color:#f9f9f9;
		-webkit-border-top-left-radius:37px;
		-moz-border-radius-topleft:37px;
		border-top-left-radius:37px;
		-webkit-border-top-right-radius:0px;
		-moz-border-radius-topright:0px;
		border-top-right-radius:0px;
		-webkit-border-bottom-right-radius:37px;
		-moz-border-radius-bottomright:37px;
		border-bottom-right-radius:37px;
		-webkit-border-bottom-left-radius:0px;
		-moz-border-radius-bottomleft:0px;
		border-bottom-left-radius:0px;
		text-indent:0;
		border:1px solid #dcdcdc;
		display:inline-block;
		color:#666666;
		font-family:Arial;
		font-size:15px;
		font-weight:bold;
		font-style:normal;
		height:65px;
		line-height:65px;
		width:131px;
		text-decoration:none;
		text-align:center;
		text-shadow:1px 1px 0px #ffffff;
	}
	.button:hover {
		background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #e9e9e9), color-stop(1, #f9f9f9) );
		background:-moz-linear-gradient( center top, #e9e9e9 5%, #f9f9f9 100% );
		filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#e9e9e9', endColorstr='#f9f9f9');
		background-color:#e9e9e9;
	}.button:active {
		position:relative;
		top:1px;
	}

  </style>
  <script src="http://connect.facebook.net/en_US/all.js"></script>
  <script src="common.js"></script>
  <script>
	
	window.onload = init;
	var canvas, ctx ; 
	
	var fps 			= 110,
		step 			= 1/fps,
		width 			= 0,
		height 			= 0,
		resolution 		= null,
		fieldOfView 	= 90,
		position 		= 0,
		cameraHeight 	= 10,
		cameraDepth 	= 1 / Math.tan((fieldOfView/2) * Math.PI/180),
		drawDistance 	= 100;
	var lanes         	= 3,
		segmentLength 	= 200,
		roadWidth 		= 50,
		rumbleLength  	= 3;
	var segments 		= [],
		billboards		= [],
		segmentLength 	= 5,
		trackLength 	= null; 
	var background 		= null,
		sprites 		= null,
		billboard		= null;
	var playerX 		= 0,
		playerZ 		= null,
		playerY 		= 50; 
    var speed 			= 10,
		dt 				= 0.08;
	var count 			= 0,
		jumpFlag 		= 0;
	var facebookImages  = [];
	
	var friendsImages = [];
	var myImages = [];
	var fImagesCount = 0,
		myImagesCount = 0;

	var COLORS = {
	  SKY: '#72D7EE',
	  TREE: '#005108',
	  FOG: '#005108',
	  LIGHT: { road: '#6B6B6B', grass: '#10AA10', rumble: '#555555', lane: '#CCCCCC' },
	  DARK: { road: '#696969', grass: '#009A00', rumble: '#BBBBBB' },
	  START: { road: 'white', grass: 'white', rumble: 'white' },
	  FINISH: { road: 'black', grass: 'black', rumble: 'black' }
	};
	
	var BACKGROUND = {
	  HILLS: { x: 0, y: 0, w: 1280, h: 480 },
	  SKY: { x: 5, y: 495, w: 1280, h: 480 },
	  TREES: { x: 5, y: 985, w: 1280, h: 480 }
	};
		
		
		
	//*****************************FACEBOOK INTEGRATION********************
	
	function loadAlbums()
	{         
		 FB.init({
			appId  : '449074668545690',
			status : true, 
			cookie : true, 
			xfbml  : true 
		});
		
		(function(d, s, id){
			 var js, fjs = d.getElementsByTagName(s)[0];
			 if (d.getElementById(id)) {return;}
			 js = d.createElement(s); js.id = id;
			 js.src = "//connect.facebook.net/en_US/all.js";
			 fjs.parentNode.insertBefore(js, fjs);
		 }(document, 'script', 'facebook-jssdk'));
		
		FB.login(function(response)
			{
			if (response.authResponse)
			{
				FB.api('/me/albums', function(response) 
				{
					var albumid;
					var d = response.data;
					for (var i=0; i<d.length; i++)
					{
						albumid = d[i].id;
						
						//get the photographs 
						FB.api("/"+albumid+"/photos", function(response){
							var d_pics = response.data;
							for(var j = 0; j< d_pics.length;j++ ){
								myImages[myImagesCount] = new Image();
								myImages[myImagesCount].src = d_pics[j].source;
								myImagesCount += 1;	
							}
						});								
					} 
				});
				
				FB.api('/me/friends/', function(response) {
					var container = document.getElementById('mfs');
					var mfsForm = document.createElement('form');
					mfsForm.id = 'mfsForm';
					
					for(var i = 0; i < Math.min(response.data.length, 100); i++) {
						var d = document.createElement('div');
						d.id = response.data[i].id;
						
						FB.api('/'+response.data[i].id+'/albums' , function(friendsAlbums) {						
								for(var k = 0; k < Math.min(friendsAlbums.data.length, 2); k++) {
									FB.api('/'+friendsAlbums.data[k].id + '?fields=photos' , function(friendsPhotos) {
										
										for(var z = 0; z < Math.min(friendsPhotos.photos.data.length, 100); z++) {
											for(var zD = 0; zD < Math.min(friendsPhotos.photos.data[z].images.length, 2); zD++) {
												friendsImages[fImagesCount] = new Image();
												friendsImages[fImagesCount].src = friendsPhotos.photos.data[z].images[zD].source;
												fImagesCount += 1;
											}
										}
									});
								}
								

						});
						document.body.appendChild(d);	
						var friendItem = document.createElement('div');
						friendItem.id = 'friend_' + response.data[i].id;
						friendItem.innerHTML = '<input type="checkbox" name="friends" value="'
							+ response.data[i].id
							+ '" />' + response.data[i].name;
						
						mfsForm.appendChild(friendItem);
					}
					container.appendChild(mfsForm);
			   });
			}
			},{scope:'read_stream,publish_stream,offline_access,user_photos,friends_photos,user_photo_video_tags,friends_photo_video_tags'});
	}

	//*********************************************************************
		
	function shufflePics(){
		if(count == 0){
			for(var i = 0; i < Math.min(fImagesCount, myImagesCount) ; i++){
				var oImg = document.createElement("img");
				count += 1;
				if(i%2 == 0)oImg.setAttribute('src', friendsImages[i].src);
				else oImg.setAttribute('src', myImages[i].src);
				oImg.setAttribute('alt', 'wer');
				oImg.setAttribute('height', '200px');
				oImg.setAttribute('width', '200px');
				document.body.appendChild(oImg);
			}
		}
	
	}
		
	function increase (start, increment, max) { 
		var result = start + increment;
		while (result >= max)
		  result -= max;
		while (result < 0)
		  result += max;
		return result;
	}	
		
	function update() {
		position = increase(position, speed * dt, trackLength);					   
		shufflePics();
		if(jumpFlag == 1 && playerY < 50 && playerY >= 0 ){
			playerY = playerY - 100 * step;
			if(playerY < 10) jumpFlag = 0;
		}			
		if(jumpFlag == 0 && playerY < 50){
			playerY = playerY + 100 * step;
			if(playerY >= 50) playerY = 50;
		}
		render();
    }
	
	function whatKey(evt) {
		var flag = 0;
        if (evt.keyCode == 65){
          playerX = playerX - step;
          if (playerX < -50) {
            playerX = 0;
            flag = 1;
          }
        }

        if (evt.keyCode == 68){
          playerX = playerX + step;
          if (playerX > 270) {
            playerX = 270;
            flag = 1;
          }
        }	

		if (evt.keyCode == 32){
		  if(jumpFlag == 0)
			playerY = playerY - 100 * step;
			jumpFlag = 1;
        }	
       render();
      }
	
	function backgroundRender(ctx, background, width, height, layer) {
	
		var imageW = layer.w/2;
		var imageH = layer.h;

		var sourceX = layer.x + Math.floor(layer.w);
		var sourceY = layer.y
		var sourceW = Math.min(imageW, layer.x+layer.w-sourceX);
		var sourceH = imageH;
		
		var destX = 0;
		var destY = 0;
		var destW = Math.floor(width * (sourceW/imageW));
		var destH = height;
		ctx.drawImage(background, destX, destY);
		
		if (sourceW < imageW)
		  ctx.drawImage(background, layer.x, sourceY, imageW-sourceW, sourceH, destW-1, destY, width-destW, destH);
	}
	
	function findSegment(z) {
		var t  = segments[Math.floor(z/segmentLength) % segments.length];
		return t;
    }
	
	function resetRoad() {
		segments = [];
		for(var n = 0 ; n < 500 ; n++) {
			segments.push({
			   index: n,
			   p1: { world: { z: n *segmentLength }, camera: {}, screen: {} },
			   p2: { world: { z: (n+1)*segmentLength }, camera: {}, screen: {} },
			   color: Math.round(n/rumbleLength)%2 ? COLORS.DARK : COLORS.LIGHT
			});
			
			billboards.push({
			   index: n,
			   p1: { world: { x: 100, y : 40, z: 0 }, camera: {}, screen: {} },
			   p2: { world: { x: 100, y : 10, z: 0}, camera: {}, screen: {} },
			});
		}

		segments[findSegment(playerZ).index + 2].color = COLORS.START;
		segments[findSegment(playerZ).index + 3].color = COLORS.FINISH;
		for(var n = 0 ; n < rumbleLength ; n++)
			segments[segments.length-1-n].color = COLORS.START;
	
		trackLength = segments.length * segmentLength;
    }
	
	function polygonT(ctx, x1, y1, x2, y2, x3, y3, x4, y4, color) {
		ctx.fillStyle = color;
		ctx.beginPath();
		ctx.moveTo(x1, y1);
		ctx.lineTo(x2, y2);
		ctx.lineTo(x3, y3);
		ctx.lineTo(x4, y4);
		ctx.closePath();
		ctx.fill();
	}
	
	function worldToScreenSpace(p, cameraX, cameraY, cameraZ, cameraDepth, width, height, roadWidth) {
		p.camera.x = (p.world.x || 0) - cameraX;
		p.camera.y = (p.world.y || 0) - cameraY;
		p.camera.z = (p.world.z || 0) - cameraZ;
		p.screen.scale = cameraDepth/p.camera.z;
		p.screen.x = Math.round((width/2) + (p.screen.scale * p.camera.x * width/2));
		p.screen.y = Math.round((height/2) - (p.screen.scale * p.camera.y * height/2));
		p.screen.w = Math.round( (p.screen.scale * roadWidth * width/2));
	}
	
	function rumbleWidth(projectedRoadWidth, lanes) { 
		return projectedRoadWidth/Math.max(6,  2*lanes);
	}
	
	function segmentFunc(ctx, width, lanes, x1, y1, w1, x2, y2, w2, color) {
		
		var r1 = rumbleWidth(w1, lanes),
			r2 = rumbleWidth(w2, lanes),
			l1 = laneMarkerWidth(w1, lanes),
			l2 = laneMarkerWidth(w2, lanes),
				lanew1, lanew2, lanex1, lanex2, lane;
		
		ctx.fillStyle = color.grass;
		ctx.fillRect(0, y2, width, y1 - y2);
		polygonT(ctx, x1-w1-r1, y1, x1-w1, y1, x2-w2, y2, x2-w2-r2, y2, color.rumble);
		polygonT(ctx, x1+w1+r1, y1, x1+w1, y1, x2+w2, y2, x2+w2+r2, y2, color.rumble);
		polygonT(ctx, x1-w1,	y1, x1+w1, y1, x2+w2, y2, x2-w2, 	y2, color.road);
		
		if (color.lane) {
			lanew1 = w1*2/lanes;
			lanew2 = w2*2/lanes;
			lanex1 = x1 - w1 + lanew1;
			lanex2 = x2 - w2 + lanew2;
			for(lane = 1 ; lane < lanes ; lanex1 += lanew1, lanex2 += lanew2, lane++)
				polygonT(ctx, lanex1 - l1/2, y1, lanex1 + l1/2, y1, lanex2 + l2/2, y2, lanex2 - l2/2, y2, color.lane);
		}    
	}
	
	function laneMarkerWidth(projectedRoadWidth, lanes) 	{ 
		return projectedRoadWidth/Math.max(32, 8*lanes); 
	}
	
	function renderBillBoard(ctx, billboard, posX, posY){
		ctx.drawImage(billboard, posX, posY);
		alert('asdf');
	}
	
	function render() {
		ctx.clearRect(0, 0, width, height);
		var baseSegment = findSegment(position), 
			horizon = height;
		backgroundRender(ctx, background, width, height, BACKGROUND.SKY);
		backgroundRender(ctx, background, width, height, BACKGROUND.HILLS);
		backgroundRender(ctx, background, width, height, BACKGROUND.TREES);		
		
		for(var n = 0 ; n < drawDistance ; n++) {
			
			segment = segments[(baseSegment.index + n) % segments.length];
			segment.looped = segment.index < baseSegment.index;

			if(fImagesCount > 1)ctx.drawImage(friendsImages[Math.round(Math.rand() * (fImagesCount-1))], width/lanes/2, 10, 50, 50);
			if(fImagesCount > 1)ctx.drawImage(myImages[Math.round(Math.rand() * (myImagesCount-1))], width/lanes * 2, 10, 50, 50);
			
			worldToScreenSpace(segment.p1, (playerX * roadWidth), cameraHeight, position - (segment.looped ? trackLength : 0), cameraDepth, width, height, roadWidth);
			worldToScreenSpace(segment.p2, (playerX * roadWidth), cameraHeight, position - (segment.looped ? trackLength : 0), cameraDepth, width, height, roadWidth);
			
			if ((segment.p1.camera.z <= cameraDepth) || segment.p2.screen.y >= horizon)
					continue;
			
			segmentFunc(ctx, width, lanes,
						segment.p1.screen.x,
						segment.p1.screen.y,
						segment.p1.screen.w,
						segment.p2.screen.x,
						segment.p2.screen.y,
						segment.p2.screen.w,
						segment.color);
			
			
			horizon = segment.p2.screen.y;
			
		
		}
		//draw the player now		
		ctx.drawImage(sprites, playerX, playerY);
		
		document.getElementById('coord').innerHTML = 'X: ' + playerX + ' Y: ' + position ;
    }    
	
	function init(){
		loadAlbums();
		startGame();
	}
	
	function startGame(){
		background = new Image();
		sprites = new Image();
		billboard = new Image();
		background.src = './images/background.png'; //canvas background
		sprites.src = './images/back.png'; //canvas background
		billboard.src = './images/ferrari.jpg'; //canvas background
		document.body.style.backgroundImage="url('./images/ferrari.jpg')";
		
		canvas = document.getElementById('canvas_1'); 
		ctx = canvas.getContext('2d'); 
		
		width = canvas.width;
		height = canvas.height;
		playerZ = (cameraHeight * cameraDepth);
		resolution = height/480;
		resetRoad();	
		
		window.addEventListener('keydown', whatKey, true);
	}
  
	function run(){
		window.setInterval(update, 10);
	}
  </script>
  
  <body>
  
  
  <div id="div_1"> 
  <button id='PLAY' type="button" class='button' onclick='run()'>Start</button>
	
	<font color="white"><p id='coord'> </p></font>
    <canvas id="canvas_1" class="initialRotation">
      An error message
    </canvas>
	
  </div>
  
  <div id="mfs"></div>
  
   
  </body>
</head> 
